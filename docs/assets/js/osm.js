// coordinate array with popup text
const points28M = [
    //[39.67243, -3.97446, "06:00 - Recogida 1ª, 2ª, 3ª y 4ª de la Virgen"],
    [39.67990, -3.98388, "06:00 - Recogida 1ª, 2ª, 3ª y 4ª de la Virgen"],  // C/ Belgrado, 14
    [39.68055, -3.97650, "06:15 - Recogida Junco"],  // C/ Toledo, 60
    [39.68252, -3.97429, "06:25 - Recogida Bastón"],  // C/ Ajofrín, 21
    [39.67915, -3.97318, "06:35 - Recogida Niña de la Bandera"],  // C/ Pedro de Heredia, 7
    [39.66986, -3.97609, "07:00 - Desayuno Junco"],  // C/ Cerrada, 32
    [39.67283, -3.97443, "08:15 - Salida Oficial"],  // C/ Candelaria, 1
    [39.67693, -3.97068, "08:30 - Ermita del Cristo"],
    [39.67801, -3.97556, "09:00 - Plaza Majuelo"],
    [39.67924, -3.97824, "09:30 - Barrio del Cerrillo"],
    [39.67632, -3.97357, "10:00 - Misa en la Iglesia Parroquial"],
    [39.67858, -3.97097, "11:15 - Ermita de la Virgen"],
    [39.67747, -3.97244, "11:45 - Casa Parroquial"],
    [39.67552, -3.97546, "12:10 - Plaza Juan Carlos I"],
    [39.67723, -3.97068, "12:30 - Casa de la Alcaldesa"],  // Avda. Fray Gabriel de la Magdalena, 15
    [39.67754, -3.98055, "13:45 - Casa del Administrador"],  // C/ Belén, 14
    [39.67269, -3.97425, "15:15 - Regreso"],
];

const points28T = [
    [39.67283, -3.97443, "17:00 - Salida Oficial"],  // C/ Candelaria, 1
    [39.67577, -3.97894, "17:10 - Plaza Malpica"],
    [39.67316, -3.98299, "17:30 - Cementerio"],
    [39.67184, -3.97892, "18:05 - Plaza del Oteruelo"],
    [39.66986, -3.97609, "18:25 - Junco"],  // C/ Cerrada, 32
    [39.67430, -3.97217, "20:05 - Plaza del Pozobueno"],
    [39.67654, -3.96836, "20:25 - Glorieta de Jesús Nazareno"],
    [39.67550, -3.97402, "20:50 - Subayudante"],  // C/ Cervantes, 7
    [39.67269, -3.97425, "22:20 - Regreso"],  // C/ Candelaria, 1
];

const pointsFinde1M = [
    [39.67693, -3.99180, "06:30 - Recogida 2ª y 4ª de la Virgen"],  // C/ Ficus, 9
    [39.67990, -3.98388, "06:50 - Recogida 1ª y 3ª de la Virgen"],  // C/ Belgrado, 14
    [39.68055, -3.97650, "07:00 - Recogida Junco"],  // C/ Toledo, 60
    [39.67920, -3.97325, "07:10 - Recogida Bastón"],  // C/ Pedro de Heredia, 7
    [39.67915, -3.97318, "07:10 - Recogida Niño de la Bandera"],  // C/ Pedro de Heredia, 7
    [39.67892, -3.97308, "07:10 - Desayuno Bastón"],  // C/ Pedro de Heredia, 7
    [39.67264, -3.97418, "08:25 - Salida Oficial"],  // C/ Candelaria, 1
    [39.67693, -3.97068, "08:35 - Ermita del Cristo"],
    [39.67858, -3.97097, "08:55 - Ermita de la Virgen"],
    [39.67801, -3.97556, "09:15 - Plaza Majuelo"],
    [39.68256, -3.98196, "09:40 - Panadera"],  // C/ Bruselas, 22
    [39.68207, -3.97268, "11:25 - 2ª del Bastón"],  // C/ Dulcinea, 6
    [39.674663, -3.970176, "13:10 - 1ª Dama"],  // C/ Juan de Padilla, 11
    [39.67283, -3.97443, "14:40 - Recogida"],  // C/ Candelaria, 1
];

const pointsFinde1T = [
    [39.67269, -3.97425, "16:30 - Salida Oficial"],  // C/ Candelaria, 1
    [39.67602, -3.99056, "16:55 - Residencia de Mayores"],  // Av. de los Olmos, 44
    [39.68025, -3.98450, "17:50 - 2º del Junco"],  // C/ La Haya, 9
    [39.67880, -3.98514, "19:25 - Pastora"],  // C/ Jesús Aguado, 7
    [39.68209, -3.97114, "21:15 - Reina"],  // C/ Rafael, s/n
    [39.67283, -3.97443, "22:45 - Regreso"],  // C/ Candelaria, 1
];

const pointsFinde2M = [
    [39.67522, -3.97441, "06:30 - Recogida 1ª y 3ª de la Virgen"],  // C/ Horno, 7
    [39.67241, -3.97449, "06:40 - Recogida 2º y 4º de la Virgen"],  // C/ San Ildefonso, 6
    [39.66986, -3.97609, "06:50 - Recogida Junco"],  // C/ Cerrada, 32
    [39.67920, -3.97325, "07:10 - Recogida Bastón"],  // C/ Pedro de Heredia, 7
    [39.67915, -3.97318, "07:10 - Recogida Niño de la Bandera"],  // C/ Pedro de Heredia, 7
    [39.67892, -3.97308, "07:10 - Desayuno Bastón"],  // C/ Pedro de Heredia, 7
    [39.67269, -3.97425, "08:20 - Salida Oficial"],  // C/ Candelaria, 1
    [39.67693, -3.97068, "08:30 - Ermita del Cristo"],
    [39.67858, -3.97097, "08:50 - Ermita de la Virgen"],
    [39.67801, -3.97556, "09:15 - Plaza Majuelo"],
    [39.67685, -3.99181, "09:50 - 2ª de la Virgen"],  // C/ Ficus, 9
    [39.67632, -3.97357, "12:00 - Misa en la Iglesia Parroquial"],  // C/ Pedro de Heredia, 7
    [39.67887, -3.97306, "13:30 - Convite Niño de la Bandera"],
    [39.67283, -3.97443, "15:15 - Regreso"],  // C/ Candelaria, 1
];

const pointsFinde2T = [
    [39.67283, -3.97443, "17:00 - Salida Oficial"],  // C/ Candelaria, 1
    [39.66972, -3.97592, "17:10 - 2º Dama"],  // C/ Cerrada, 36
    [39.67665, -3.98257, "19:00 - Laborante"],  // C/ San Miguel, 9
    [39.67505, -3.97159, "20:50 - 1ª del Bastón"],  // C/ María Cristina, 10
    [39.67269, -3.97425, "22:20 - Regreso"],  // C/ Candelaria, 1
];

const points7 = [
    [39.67283, -3.97443, "17:20 - Salida Oficial"],
    [39.67579, -3.97511, "17:35 - Recogida de Autoridades"],
    [39.67747, -3.97244, "17:45 - Recogida de Patronato"],
    [39.67853, -3.97123, "18:00 - Eucaristía con Vísperas"],
    [39.67265, -3.97422, "19:30 - Alférez"],
    [39.67790, -3.96973, "21:30 - Pregón"],
    [39.67858, -3.97094, "23:30 - Salve"],
    [39.68151, -3.97019, "00:00 - Pólvora"],
    [39.67274, -3.97433, "01:00 - Regreso"],  // C/ Candelaria, 1
];

const points8 = [
    [39.67659, -3.97452, "08:45 - Salida con Banda de Música"],  // C/ Toledo, 7
    [39.67915, -3.97318, "08:55 - Desayuno y Baile Niña de la Bandera"],  // C/ Pedro de Heredia, 7
    [39.67283, -3.97443, "10:00 - Salida Oficial con Banda de Música"],  // C/ Candelaria, 1
    [39.67579, -3.97511, "10:10 - Recogida de Autoridades"],
    [39.67747, -3.97244, "10:15 - Recogida de Patronato"],
    [39.67853, -3.97123, "10:30 - Eucaristía"],
    [39.67575, -3.97518, "11:40 - Recepción popular"],
    [39.67847, -3.97133, "12:30 - Ofrecimiento"],
    [39.67858, -3.97094, "20:30 - Rosario y Procesión"],
];

const pointsOctM = [
    [39.67658, -3.97453, "10:15 - Salida con Banda de Música"],  // C/ Toledo, 7
    [39.67915, -3.97318, "10:25 - Desayuno Niña de la Bandera"],  // C/ Pedro de Heredia, 7
    [39.67283, -3.97443, "11:30 - Salida Oficial"],
    [39.67579, -3.97511, "11:40 - Recogida de Autoridades"],
    [39.67747, -3.97244, "11:45 - Recogida de Patronato"],
    [39.67853, -3.97123, "12:00 - Eucaristía"],
    [39.67860, -3.97082, "13:00 - Rifa del grano"],
];

const pointsOctT = [
    [39.67858, -3.97094, "19:30 - Novena y Procesión"],
    [39.67842, -3.97081, "22:00 - Cambio de alabardas"],
    [39.67847, -3.97110, "22:30 - Rifa de la bandera"],
    [39.67835, -3.97114, "23:30 - Bailes de bandera de antiguos Alféreces"],
    [39.67858, -3.97055, "00:00 - Traca final de Feria"],
    [39.67876, -3.97047, "00:15 - Nuevo Niño de la bandera"],
    [39.67892, -3.97053, "00:30 - Convite nuevo Niño de la bandera"],
    [39.67233, -3.97378, "01:30 - Regreso nuevo alférez"]
];

// Map config
let config = {
    minZoom: 7,
    maxZoom: 18,
};
const zoom = 18;
const lat = 39.67194;
const lng = -3.97388;

// calling map
const map = L.map("map", config).setView([lat, lng], zoom);

L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution:
        '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
}).addTo(map);


const p28M = new L.FeatureGroup();
const p28T = new L.FeatureGroup();
const pFinde1M = new L.FeatureGroup();
const pFinde1T = new L.FeatureGroup();
const pFinde2M = new L.FeatureGroup();
const pFinde2T = new L.FeatureGroup();
const p7 = new L.FeatureGroup();
const p8 = new L.FeatureGroup();
const pOctM = new L.FeatureGroup();
const pOctT = new L.FeatureGroup();
const allMarkers = new L.FeatureGroup();

// adding markers to the layer points28M
create_group(points28M, p28M, '05519E', '03366B', 'FFF')

// adding markers to the layer points28T
create_group(points28T, p28T, 'FFD326', 'C1A32D', 'FFF')

// adding markers to the layer pointsFinde1M
create_group(pointsFinde1M, pFinde1M, '23B721', '146A13', 'FFF')

// adding markers to the layer pointsFinde1T
create_group(pointsFinde1T, pFinde1T, 'CB2B3E', '982E40', 'FFF')

// adding markers to the layer pointsFinde2M
create_group(pointsFinde2M, pFinde2M, '9C2BCB', '742E98', 'FFF')

// adding markers to the layer pointsFinde2T
create_group(pointsFinde2T, pFinde2T, '7B7B7B', '6B6B6B', 'FFF')

// adding markers to the layer points7
create_group(points7, p7, 'FFFFFF', '000', '000')

// adding markers to the layer points8
create_group(points8, p8, '00BCD4', '007887', 'FFF')

// adding markers to the layer pointsOct1T
//create_group(pointsOct1T, p16, 'F0EEAC', 'D9CF91', '000')

// adding markers to the layer pointsOctM
create_group(pointsOctM, pOctM, 'C26224', '753B15', 'FFF')

// adding markers to the layer pointsOctT
create_group(pointsOctT, pOctT, 'f9191A', 'AC1112', 'FFF')

// object with layers
const overlayMaps = {
    "28/8 Mañana": p28M,
    "28/8 Tarde": p28T,
    "31/8 Mañana": pFinde1M,
    "31/8 Tarde": pFinde1T,
    "1/9 Mañana": pFinde2M,
    "1/9 Tarde": pFinde2T,
    "7/9 Tarde": p7,
    "8/9 Mañana": p8,
    "15/9 Mañana": pOctM,
    "15/9 Tarde": pOctT,
};

// centering a group of markers
map.on("layeradd layerremove", function () {
    // Create new empty bounds
    let bounds = new L.LatLngBounds();
    // Iterate the map's layers
    map.eachLayer(function (layer) {
        // Check if layer is a featuregroup
        if (layer instanceof L.FeatureGroup) {
            // Extend bounds with group's bounds
            bounds.extend(layer.getBounds());
        }
    });

    // Check if bounds are valid (could be empty)
    if (bounds.isValid()) {
        // Valid, fit bounds
        map.flyToBounds(bounds);
    } else {
        // Invalid, fit world
        // map.fitWorld();
    }
});

var layerControl = new L.control.layers(null, overlayMaps, { collapsed: false }).addTo(map);

var legend = document.querySelectorAll('.leaflet-control-layers-selector')
legend[0].parentElement.style.color = '#05519E';
legend[1].parentElement.style.color = '#C1A32D';
legend[2].parentElement.style.color = '#23B721';
legend[3].parentElement.style.color = '#CB2B3E';
legend[4].parentElement.style.color = '#742E98';
legend[5].parentElement.style.color = '#6B6B6B';
legend[6].parentElement.style.color = '#000000';
legend[7].parentElement.style.color = '#007887';
legend[8].parentElement.style.color = '#C26224';
legend[9].parentElement.style.color = '#AC1112';

function create_group(array, group, background, line, text) {
    for (let i = 0; i < array.length; i++) {
        // URL de Google Maps con las coordenadas
        const googleMapsUrl = `https://www.google.com/maps?q=${array[i][0]},${array[i][1]}`;

        // Texto del enlace con el icono de enlace
        const linkHtml = `<br><a href="${googleMapsUrl}" target="_blank" style="color: #0078ff;">&#128279; Ir</a>`;

        // Popup con el texto original más el enlace a Google Maps
        marker = L.marker([array[i][0], array[i][1]], {
            icon: new L.Icon({
                iconUrl: `https://marker.nanoka.fr/map_pin-${background}-${text}-${line}-${(i + 1)}-40.svg`,
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            })
        }).bindPopup(array[i][2] + linkHtml);

        group.addLayer(marker);
    }

    for (let i = 0; i < array.length - 1; i++) {
        var pointA = new L.LatLng(array[i][0], array[i][1]);
        var pointB = new L.LatLng(array[i + 1][0], array[i + 1][1]);

        var firstpolyline = new L.Polyline([pointA, pointB], {
            color: `#${line}`,
            weight: 3,
            opacity: 0.5,
            smoothFactor: 1
        });
        group.addLayer(firstpolyline);
    }
}