// coordinate array with popup text
const points28M = [
    [39.67243, -3.97446, "06:00 - Recogida 1ª, 2ª, 3ª y 4ª de la Virgen"],
    [39.67920, -3.97325, "06:30 - Recogida Bastón"],
    [39.68055, -3.97650, "06:40 - Recogida Junco"],
    [39.67902, -3.97405, "06:50 - Recogida Niño de la Bandera"],
    [39.67915, -3.97318, "07:00 - Desayuno Bastón"],
    [39.67283, -3.97443, "08:15 - Salida Oficial"],
    [39.67693, -3.97068, "08:30 - Ermita del Cristo"],
    [39.67801, -3.97556, "09:00 - Plaza Majuelo"],
    [39.67924, -3.97824, "09:30 - Barrio del Cerrillo"],
    [39.67632, -3.97357, "10:00 - Misa en la Iglesia Parroquial"],
    [39.67858, -3.97097, "11:15 - Ermita de la Virgen"],
    [39.67747, -3.97244, "11:50 - Casa Parroquial"],
    [39.67552, -3.97546, "12:10 - Plaza Juan Carlos I"],
    [39.67723, -3.97068, "12:30 - Casa de la Alcaldesa"],
    [39.67754, -3.98055, "13:45 - Casa del Administrador"],
    [39.67269, -3.97425, "15:15 - Regreso"],
];

const points28T = [
    [39.67283, -3.97443, "17:00 - Salida Oficial"],
    [39.67577, -3.97894, "17:10 - Plaza Malpica"],
    [39.67316, -3.98299, "17:25 - Cementerio"],
    [39.67184, -3.97892, "17:55 - Plaza del Oteruelo"],
    [39.67193, -3.97261, "18:20 - 2ª Dama"],
    [39.67430, -3.97217, "19:55 - Plaza del Pozobueno"],
    [39.67654, -3.96836, "20:15 - Glorieta de Jesús Nazareno"],
    [39.67920, -3.97325, "20:40 - Bastón"],
    [39.67269, -3.97425, "22:10 - Regreso"],
];

const points2M = [
    [39.67693, -3.99180, "06:45 - Recogida 1ª, 2ª, 3ª y 4ª de la Virgen"],
    [39.68055, -3.97650, "07:15 - Recogida Junco"],
    [39.67920, -3.97325, "07:25 - Recogida Bastón"],
    [39.67902, -3.97405, "07:30 - Recogida Niño de la Bandera"],
    [39.66986, -3.97609, "07:55 - Desayuno Junco"],
    [39.67283, -3.97443, "08:45 - Salida Oficial"],
    [39.67693, -3.97068, "09:00 - Ermita del Cristo"],
    [39.67858, -3.97097, "09:20 - Ermita de la Virgen"],
    [39.67801, -3.97556, "09:40 - Plaza Majuelo"],
    [39.68582, -3.97582, "10:00 - Arriera"],
    [39.67243, -3.97446, "11:50 - 4ª de la Virgen"],
    [39.67571, -3.97586, "12:15 - Convite 4ª de la Virgen"],
    [39.67247, -3.96911, "13:45 - Ayudante"],
    [39.67269, -3.97425, "14:30 - Salida en bus"],
    [39.67363, -3.99460, "15:00 - Convite Ayudante"],
    [39.67264, -3.97418, "15:30 - Recogida"],
];

const points2T = [
    [39.67283, -3.97443, "16:45 - Salida Oficial en bus"],
    [39.67602, -3.99056, "17:00 - Residencia de Mayores"],
    [39.67849, -3.97765, "18:00 - Hortelana"],
    [39.67525, -3.97447, "19:40 - 3ª de la Virgen"],
    [39.67101, -3.97277, "21:20 - 1ª Dama"],
    [39.67571, -3.97586, "21:50 - Convite 1ª Dama"],
    [39.67269, -3.97425, "22:50 - Regreso"],
];

const points3M = [
    [39.67522, -3.97441, "06:30 - Recogida 1ª, 2ª, 3ª y 4ª de la Virgen"],
    [39.68055, -3.97650, "06:45 - Recogida Junco"],
    [39.67920, -3.97325, "06:55 - Recogida Bastón"],
    [39.67902, -3.97405, "07:00 - Recogida Niño de la Bandera"],
    [39.66987, -3.97597, "07:30 - Desayuno Junco"],
    [39.67269, -3.97425, "08:20 - Salida Oficial"],
    [39.67693, -3.97068, "08:35 - Ermita del Cristo"],
    [39.67858, -3.97097, "08:55 - Ermita de la Virgen"],
    [39.67801, -3.97556, "09:30 - Plaza Majuelo"],
    [39.67990, -3.98388, "10:00 - 1ª de la Virgen"],
    [39.67632, -3.97357, "12:00 - Misa en la Iglesia Parroquial"],
    [39.67571, -3.97586, "13:30 - Convite Niño de la Bandera"],
    [39.67283, -3.97443, "15:30 - Regreso"],
];

const points3T = [
    [39.67283, -3.97443, "17:00 - Salida Oficial"],
    [39.66974, -3.97587, "17:10 - Labradora"],
    [39.67023, -3.97612, "17:30 - Salida en bus"],
    [39.67972, -3.98558, "17:40 - Convite Labradora"],
    [39.67037, -3.97630, "18:40 - Regreso en bus"],
    [39.67421, -3.96959, "18:55 - Reina"],
    [39.67342, -3.96846, "20:50 - Salida en bus"],
    [39.67452, -4.00312, "21:10 - 1ª del Junco"],
    [39.67280, -3.97489, "21:40 - Regreso en bus"],
    [39.67269, -3.97425, "22:00 - Regreso"],
    [39.67612, -3.96108, "22:30 - Convite 1ª del Junco"],
];

const points7 = [
    [39.67283, -3.97443, "17:20 - Salida Oficial"],
    [39.67579, -3.97511, "17:35 - Recogida de Autoridades"],
    [39.67747, -3.97244, "17:45 - Recogida de Patronato"],
    [39.67853, -3.97123, "18:00 - Eucaristía con Vísperas"],
    [39.67265, -3.97422, "19:30 - Alférez"],
    [39.67790, -3.96973, "21:30 - Pregón"],
    [39.67858, -3.97094, "23:30 - Salve"],
    [39.68151, -3.97019, "00:00 - Pólvora"],
    [39.67274, -3.97433, "01:00 - Regreso"],
];

const points8 = [
    [39.67283, -3.97443, "08:30 - Salida Oficial con Banda de Música"],
    [39.67902, -3.97405, "08:45 - Desayuno y Baile Niño de la Bandera"],
    [39.67579, -3.97511, "10:10 - Recogida de Autoridades"],
    [39.67747, -3.97244, "10:15 - Recogida de Patronato"],
    [39.67853, -3.97123, "10:30 - Eucaristía"],
    [39.67575, -3.97518, "11:40 - Recepción popular"],
    [39.67847, -3.97133, "12:30 - Ofrecimiento"],
    [39.67858, -3.97094, "20:30 - Novena y Procesión"],
];

const points16 = [
    [39.67850, -3.97100, "18:20 - Salida Oficial"],
    [39.67421, -3.96959, "18:30 - Baile de la Bandera Reina"],
    [39.67274, -3.97433, "19:00 - Regreso"],
];

const points17M = [
    [39.67658, -3.97453, "10:20 - Salida con Banda de Música"],
    [39.67902, -3.97405, "10:30 - Desayuno Niño de la Bandera"],
    [39.67283, -3.97443, "11:30 - Salida Oficial"],
    [39.67579, -3.97511, "10:40 - Recogida de Autoridades"],
    [39.67747, -3.97244, "10:45 - Recogida de Patronato"],
    [39.67853, -3.97123, "12:00 - Eucaristía"],
    [39.67860, -3.97082, "13:00 - Rifa del grano"],
];

const points17T = [
    [39.67858, -3.97094, "19:30 - Novena y Procesión"],
    [39.67853, -3.97111, "22:30 - Rifa de la bandera"],
    [39.67847, -3.97110, "00:00 - Bailes de bandera de antiguos Alféreces"],
    [39.67858, -3.97055, "01:00 - Traca final de Feria"],
    [39.67879, -3.97042, "01:15 - Nuevo niño de la bandera (Dirección desconocida)"],
    [39.67265, -3.97422, "02:30 - Regreso"]
];

// Map config
let config = {
    minZoom: 7,
    maxZoom: 18,
};
const zoom = 18;
const lat = 39.67194;
const lng = -3.97388;

// calling map
const map = L.map("map", config).setView([lat, lng], zoom);

L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", {
    attribution:
        '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
}).addTo(map);


const p28M = new L.FeatureGroup();
const p28T = new L.FeatureGroup();
const p2M = new L.FeatureGroup();
const p2T = new L.FeatureGroup();
const p3M = new L.FeatureGroup();
const p3T = new L.FeatureGroup();
const p7 = new L.FeatureGroup();
const p8 = new L.FeatureGroup();
const p16 = new L.FeatureGroup();
const p17M = new L.FeatureGroup();
const p17T = new L.FeatureGroup();
const allMarkers = new L.FeatureGroup();

// adding markers to the layer points28M
create_group(points28M, p28M, '05519E', '03366B', 'FFF')

// adding markers to the layer points28T
create_group(points28T, p28T, 'FFD326', 'C1A32D', 'FFF')

// adding markers to the layer points2M
create_group(points2M, p2M, '23B721', '146A13', 'FFF')

// adding markers to the layer points2T
create_group(points2T, p2T, 'CB2B3E', '982E40', 'FFF')

// adding markers to the layer points3M
create_group(points3M, p3M, '9C2BCB', '742E98', 'FFF')

// adding markers to the layer points3T
create_group(points3T, p3T, '7B7B7B', '6B6B6B', 'FFF')

// adding markers to the layer points7
create_group(points7, p7, 'FFFFFF', '000', '000')

// adding markers to the layer points8
create_group(points8, p8, '00BCD4', '007887', 'FFF')

// adding markers to the layer points16
create_group(points16, p16, 'F0EEAC', 'D9CF91', '000')

// adding markers to the layer points17M
create_group(points17M, p17M, 'C26224', '753B15', 'FFF')

// adding markers to the layer points17T
create_group(points17T, p17T, 'f9191A', 'AC1112', 'FFF')

// object with layers
const overlayMaps = {
    "28/8 Mañana": p28M,
    "28/8 Tarde": p28T,
    "2/9 Mañana": p2M,
    "2/9 Tarde": p2T,
    "3/9 Mañana": p3M,
    "3/9 Tarde": p3T,
    "7/9 Tarde": p7,
    "8/9 Mañana": p8,
    "16/9 Tarde": p16,
    "17/9 Mañana": p17M,
    "17/9 Tarde": p17T,
};

// centering a group of markers
map.on("layeradd layerremove", function () {
    // Create new empty bounds
    let bounds = new L.LatLngBounds();
    // Iterate the map's layers
    map.eachLayer(function (layer) {
        // Check if layer is a featuregroup
        if (layer instanceof L.FeatureGroup) {
            // Extend bounds with group's bounds
            bounds.extend(layer.getBounds());
        }
    });

    // Check if bounds are valid (could be empty)
    if (bounds.isValid()) {
        // Valid, fit bounds
        map.flyToBounds(bounds);
    } else {
        // Invalid, fit world
        // map.fitWorld();
    }
});

var layerControl = new L.control.layers(null, overlayMaps, { collapsed: false }).addTo(map);

var legend = document.querySelectorAll('.leaflet-control-layers-selector')
legend[0].parentElement.style.color = '#05519E';
legend[1].parentElement.style.color = '#C1A32D';
legend[2].parentElement.style.color = '#23B721';
legend[3].parentElement.style.color = '#CB2B3E';
legend[4].parentElement.style.color = '#742E98';
legend[5].parentElement.style.color = '#6B6B6B';
legend[6].parentElement.style.color = '#000000';
legend[7].parentElement.style.color = '#007887';
legend[8].parentElement.style.color = '#C26224';
legend[9].parentElement.style.color = '#AC1112';

function create_group(array, group, background, line, text) {
    for (let i = 0; i < array.length; i++) {
        marker = L.marker([array[i][0], array[i][1]], {
            icon: new L.Icon({
                iconUrl: `https://marker.nanoka.fr/map_pin-${background}-${text}-${line}-${(i + 1)}-40.svg`,
                shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            })
        }).bindPopup(array[i][2]);
        group.addLayer(marker);
    }
    
    for (let i = 0; i < array.length - 1; i++) {
        var pointA = new L.LatLng(array[i][0], array[i][1]);
        var pointB = new L.LatLng(array[i + 1][0], array[i + 1][1]);
    
        var firstpolyline = new L.Polyline([pointA, pointB], {
            color: `#${line}`,
            weight: 3,
            opacity: 0.5,
            smoothFactor: 1
        });
        group.addLayer(firstpolyline);
    }
}